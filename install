#!/bin/bash

UNAME=passman
BASE_DIR=/opt/passman
BINNAME=passman

###################### Installer follows, do not edit ######################

set -e
. settings

[ ! "$(id -u)" = 0 ] && {
    echo "You must be root to install this application."
    return 1
}

id $UNAME &>/dev/null && {
    echo "The user '$UNAME' already exists, please choose a different username."
    return 2
}

ls $BASE_DIR/* &>/dev/null && {
    echo "'$BASE_DIR' is not empty, please choose a different installation folder."
    return 3
}

[ -e /usr/local/bin/$BINNAME ] && {
    echo "/usr/local/bin/$BINNAME already exists, please choose a different name."
    return 4
}

read -p "Initial administrator: " iuser
read -ps "${iuser}'s password: " pw1
read -ps "Retype password: " pw2

[ $pw1 = $pw2 ] && {
    echo "Passwords do not match, please try again."
    return 5
}

useradd -rUN -d $BASE_DIR -s /bin/false $UNAME
mkdir $BASE_DIR
rm -rf $BASE_DIR/*
git clone git://github.com/booski/passman.git $BASE_DIR
cat<<EOF > $BASE_DIR/settings
UNAME=$UNAME
BASE_DIR=$BASE_DIR
EOF
chown -R passman $BASE_DIR
chmod u+sx $BASE_DIR/passman
ln -s /usr/local/bin/passman $BASE_DIR/passman

(
    cd ~$UNAME
    . cryptapi.sh
    bootstrap $iuser $pw1
)
