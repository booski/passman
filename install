#!/bin/bash

# The user that passman will run as. The user must not exist prior to running this script.
APPUSER=passman

# The system group that users must belong to to be able to run this application. 
# Will not be created or validated by this installer.
APPGROUP=dmc

# The directory that the application will be installed in.
# The directory does not have to exist, but it must be empty if it does.
APPHOME=/opt/passman

# The name under which the application will be symlinked in /usr/local/bin.
BINNAME=passman


###################### Installer follows, do not edit ######################

set -e

[ ! "$(id -u)" = 0 ] && {
    echo "You must be root to install this application."
    exit 1
}

ls $APPHOME/* &>/dev/null && {
    echo "'$APPHOME' is not empty, please choose a different installation folder."
    exit 2
}

[ -e /usr/local/bin/$BINNAME ] && {
    echo "/usr/local/bin/$BINNAME already exists, please choose a different name."
    exit 3
}

read -p "Initial administrator: " iuser
read -sp "${iuser}'s password: " pw1
echo
read -sp "Retype password: " pw2
echo

[ "$pw1" = "$pw2" ] || {
    echo "Passwords do not match, please try again."
    exit 4
}

cp /etc/sudoers /etc/sudoers.tmp
chmod 640 /etc/sudoers.tmp
echo "%$APPGROUP ALL=($APPNAME) NOPASSWD: $APPHOME/passman" >> /etc/sudoers.tmp
visudo -cf /etc/sudoers.tmp || {
    echo "Failed to update sudoers file, aborting."
    rm /etc/sudoers.tmp
    exit 5
}

chmod 440 /etc/sudoers.tmp
mv /etc/sudoers.tmp /etc/sudoers

useradd -rN -d $APPHOME -s /bin/false $APPNAME
git clone git://github.com/booski/passman.git $APPHOME
ln -s $APPHOME/passman /usr/local/bin/$BINNAME

(
    cd $APPHOME
    . cryptapi.sh
    bootstrap $iuser $pw1
)

chown -R $APPNAME $APPHOME
chmod -R u=rwX,g=rX,o=rX $APPHOME
