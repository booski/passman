#!/bin/bash

# The user that passman will run as. The user must not exist prior to running this script.
APPUSER=passman

# The system group that users must belong to to be able to run this application. 
# Will be created if it doesn't exist.
APPGROUP=passman

# The directory that the application will be installed in.
# The directory does not have to exist, but it must be empty if it does.
APPHOME=/opt/passman

# The name under which the application will be symlinked in /usr/local/bin.
BINNAME=passman


###################### Installer follows, do not edit ######################

set -e

function die {
    echo "$1"
    echo "No changes have been made to the system."
    exit $2
}

[ ! "$(id -u)" = 0 ] && {
    die "You must be root to install this application." 1
}

ls $APPHOME/* &>/dev/null && {
    die "'$APPHOME' is not empty, please choose a different installation folder." 2
}

[ -h /usr/local/bin/$BINNAME ] && {
    die "/usr/local/bin/$BINNAME already exists, please choose a different name." 3
}

read -p "Initial administrator: " iuser
read -sp "${iuser}'s password: " pw1
echo
read -sp "Retype password: " pw2
echo

[ "$pw1" = "$pw2" ] || {
    die "Passwords do not match, please try again." 4
}


[ -e /etc/sudoers.d/${APPGROUP}"-"$BINNAME ] && {
    rm /etc/sudoers.tmp
    die "There is already a file /etc/sudoers.d/${APPGROUP}-$BINNAME, please choose a different name" 5
}

touch /etc/sudoers.d/${APPGROUP}"-"$BINNAME
echo "%$APPGROUP ALL=($APPUSER) NOPASSWD: $APPHOME/passman" > /etc/sudoers.d/${APPGROUP}"-"$BINNAME
chmod 440 /etc/sudoers.d/${APPGROUP}"-"$BINNAME

groupadd -r $APPGROUP || true
useradd -rN -d $APPHOME -s /bin/false -g $APPGROUP $APPUSER
git clone git://github.com/booski/passman.git $APPHOME
ln -s $APPHOME/passman /usr/local/bin/$BINNAME

(
    cd $APPHOME
    . cryptapi.sh
    bootstrap $iuser $pw1
)

chown -R $APPUSER $APPHOME
chmod -R u=rwX,g=rX,o=rX $APPHOME
