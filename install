#!/bin/bash

# The name of the user that the application will run as.
APPNAME=passman

# The directory that the application will be installed in.
APPHOME=/opt/passman

# The name under which the application will be symlinked in /usr/local/bin.
BINNAME=passman

# All of the values chosen above must be free for installation to proceed.


###################### Installer follows, do not edit ######################

set -e
. settings

[ ! "$(id -u)" = 0 ] && {
    echo "You must be root to install this application."
    exit 1
}

id $APPNAME &>/dev/null && {
    echo "The user '$APPNAME' already exists, please choose a different username."
    exit 2
}

ls $APPHOME/* &>/dev/null && {
    echo "'$APPHOME' is not empty, please choose a different installation folder."
    exit 3
}

[ -e /usr/local/bin/$BINNAME ] && {
    echo "/usr/local/bin/$BINNAME already exists, please choose a different name."
    exit 4
}

read -p "Initial administrator: " iuser
read -ps "${iuser}'s password: " pw1
read -ps "Retype password: " pw2

[ "$pw1" = "$pw2" ] && {
    echo "Passwords do not match, please try again."
    exit 5
}

useradd -rUN -d $APPHOME -s /bin/false $APPNAME
mkdir $APPHOME
rm -rf $APPHOME/*
git clone git://github.com/booski/passman.git $APPHOME
cat<<EOF > $APPHOME/settings
APPNAME=$APPNAME
APPHOME=$APPHOME
EOF
chown -R passman $APPHOME
chmod u+sx $APPHOME/passman
ln -s /usr/local/bin/passman $APPHOME/passman

(
    cd ~$APPNAME
    . cryptapi.sh
    bootstrap $iuser $pw1
)
