#!/bin/bash

# The directory that the application will be installed in.
APPHOME=/opt/passman

# The name under which the application will be symlinked in /usr/local/bin.
BINNAME=passman

# All of the values chosen above must be free for installation to proceed.


###################### Installer follows, do not edit ######################

set -e

[ ! "$(id -u)" = 0 ] && {
    echo "You must be root to install this application."
    exit 1
}

ls $APPHOME/* &>/dev/null && {
    echo "'$APPHOME' is not empty, please choose a different installation folder."
    exit 2
}

[ -e /usr/local/bin/$BINNAME ] && {
    echo "/usr/local/bin/$BINNAME already exists, please choose a different name."
    exit 3
}

read -p "Initial administrator: " iuser
read -sp "${iuser}'s password: " pw1
echo
read -sp "Retype password: " pw2
echo

[ "$pw1" = "$pw2" ] || {
    echo "Passwords do not match, please try again."
    exit 4
}

git clone git://github.com/booski/passman.git $APPHOME
chown -R passman $APPHOME
chmod -R u=rwX,g=rX,o=rX $APPHOME
chmod u+sx $APPHOME/passman
ln -s $APPHOME/passman /usr/local/bin/$BINNAME

(
    cd $APPHOME
    . cryptapi.sh
    bootstrap $iuser $pw1
)
